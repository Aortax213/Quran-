<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูุดุบู ุงููุฑุขู โ ุชุฌุฑุจุฉ ูุชุนุฏุฏุฉ ุงููุตุงุฏุฑ</title>
  <style>
    body { background:#0b1116; color:#e6eef3; font-family: "Cairo", sans-serif; padding:20px; text-align:center; }
    .card { max-width:900px; margin:16px auto; background:linear-gradient(180deg,#071018,#0e2230); border-radius:12px; padding:22px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    h1{ color:#a6e1ff; margin-bottom:6px; }
    p.small{ color:#b9ccd6; margin-top:0; margin-bottom:12px; }
    select, button { padding:12px 16px; font-size:16px; border-radius:8px; border: none; margin:8px; }
    select { background:#0b2a32; color:#e6eef3; }
    button.play { background:#f0c34b; color:#062023; font-weight:700; min-width:180px; }
    button.small { background:#12343f; color:#cfeff6; }
    audio { width:90%; margin-top:18px; border-radius:12px; }
    .log { text-align:left; max-height:160px; overflow:auto; margin-top:14px; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; color:#c7dfe6; font-size:13px; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; align-items:center; }
    .note { color:#9fb8bf; font-size:13px; margin-top:8px; }
    @media(max-width:600px){ .card{ padding:14px } audio{ width:100% } }
  </style>
</head>
<body>
  <div class="card">
    <h1>๐ ูุดุบู ุงููุฑุขู (ุชุฌุฑุจุฉ ูุตุงุฏุฑ ูุชุนุฏุฏุฉ)</h1>
    <p class="small">ุงุฎุชุฑ ุงููุงุฑุฆ ูุงูุณูุฑุฉ โ ุงูุตูุญุฉ ุณุชุญุงูู ุชููุงุฆููุง ุนุฏุฉ ูุตุงุฏุฑ ุญุชู ุชุนูู.</p>

    <div class="row">
      <label>ุงููุงุฑูุก:</label>
      <select id="reciter">
        <!-- ุฃุณูุงุก ุงูููุชุงุญูุฉ ุงููุณุชุฎุฏูุฉ ูู ุงูุฑูุงุจุท -->
        <option value="s_gmd">ุณุนุฏ ุงูุบุงูุฏู (mp3quran)</option>
        <option value="juhany">ุนุจุฏ ุงููู ุงูุฌููู (mp3quran)</option>
        <option value="ar.alafasy">ูุดุงุฑู ุฑุงุดุฏ ุงูุนูุงุณู (cdn.islamic.network)</option>
        <option value="ar.saad_alghamdi">ุณุนุฏ ุงูุบุงูุฏู (cdn.islamic.network)</option>
        <option value="ar.mahermuaiqly">ูุงูุฑ ุงููุนูููู (cdn.islamic.network)</option>
      </select>

      <label>ุงูุณูุฑุฉ:</label>
      <select id="surah"></select>
      <button class="play" id="playBtn">ุชุดุบูู ุงูุณูุฑุฉ โถ</button>
    </div>

    <audio id="player" controls></audio>

    <div class="row" style="margin-top:12px;">
      <button class="small" id="prevBtn">ุงูุณุงุจู</button>
      <button class="small" id="nextBtn">ุงูุชุงูู</button>
      <button class="small" id="clearCacheBtn">ูุณุญ ุงูุณุฌู</button>
    </div>

    <div class="note">ููุงุญุธุฉ: ุงูุตูุญุฉ ุชุญุงูู ุฑูุงุจุท ูู ูุตุงุฏุฑ ูุชุนุฏุฏุฉ (mp3quran servers ู CDN). ุฅู ูู ูุนูู ุฃุญุฏูุงุ ุณูุฌุฑูุจ ุงูุชุงูู ุชููุงุฆูุงู.</div>

    <div class="log" id="log"></div>
  </div>

<script>
/*
  ููุทู ุงูุชุดุบูู:
  - ูุงุฆูุฉ ุณูุฑ 1..114 ูุฑููุฉ ูุน ุงูุฃุณูุงุก ุงูุนุฑุจูุฉ
  - ุนูุฏ ุงูุถุบุท ุชุดุบูู: ูููุฏ ูุงุฆูุฉ ุฑูุงุจุท ูุฑุดุญุฉ ุญุณุจ ุงููุงุฑุฆ:
      - ูู ุงููุงุฑุฆ ูู mp3quran (ูุซุงู value = 's_gmd' ุฃู 'juhany'):
          ูุฌุฑุจ ุฑูุงุจุท server8, server11, server13 ุจุตูุบุฉ: https://server8.mp3quran.net/{reciter}/{NNN}.mp3
          ุจุนุถ ุงูุณูุฑ ูู mp3quran ุชุณุชุฎุฏู ุตูุฑ ุจุงุฏุฆ 3 ุฎุงูุงุช (001..114)
      - ูู ุงููุงุฑุฆ ูู cdn.islamic.network (value ูุจุฏุฃ ุจู 'ar.'):
          ุฑุงุจุท ุจุตูุบุฉ: https://cdn.islamic.network/quran/audio-surah/128/{reciter}/{num}.mp3
  - ูุญุงูู ูู ุฑุงุจุท ุจุงูุชุณูุณู: ูุถุนู ูู audio.src ููุณุชุฏุนู load() ุซู play(): 
      - ุฅู ุญุฏุซ error => ูุฌุฑุจ ุงูุฑุงุจุท ุงูุชุงูู
      - ุฅู ุดุบูู โ ูุณุฌู ูู ุงูููุบ ููุจูู ุนููู
*/

const surahNames = [
"ุงููุงุชุญุฉ","ุงูุจูุฑุฉ","ุขู ุนูุฑุงู","ุงููุณุงุก","ุงููุงุฆุฏุฉ","ุงูุฃูุนุงู","ุงูุฃุนุฑุงู","ุงูุฃููุงู","ุงูุชูุจุฉ",
"ูููุณ","ููุฏ","ููุณู","ุงูุฑุนุฏ","ุฅุจุฑุงููู","ุงูุญุฌุฑ","ุงููุญู","ุงูุฅุณุฑุงุก","ุงูููู","ูุฑูู","ุทู",
"ุงูุฃูุจูุงุก","ุงูุญุฌ","ุงููุคูููู","ุงูููุฑ","ุงููุฑูุงู","ุงูุดุนุฑุงุก","ุงูููู","ุงููุตุต","ุงูุนููุจูุช","ุงูุฑูู",
"ูููุงู","ุงูุณุฌุฏุฉ","ุงูุฃุญุฒุงุจ","ุณุจุฃ","ูุงุทุฑ","ูุณ","ุงูุตุงูุงุช","ุต","ุงูุฒูุฑ","ุบุงูุฑ","ูุตูุช",
"ุงูุดูุฑู","ุงูุฒุฎุฑู","ุงูุฏุฎุงู","ุงูุฌุงุซูุฉ","ุงูุฃุญูุงู","ูุญูุฏ","ุงููุชุญ","ุงูุญุฌุฑุงุช","ู","ุงูุฐุงุฑูุงุช",
"ุงูุทูุฑ","ุงููุฌู","ุงูููุฑ","ุงูุฑุญูู","ุงููุงูุนุฉ","ุงูุญุฏูุฏ","ุงููุฌุงุฏูุฉ","ุงูุญุดุฑ","ุงูููุชุญูุฉ","ุงูุตู",
"ุงูุฌูุนุฉ","ุงูููุงูููู","ุงูุชุบุงุจู","ุงูุทูุงู","ุงูุชุญุฑูู","ุงูููู","ุงูููู","ุงูุญุงูุฉ","ุงููุนุงุฑุฌ","ููุญ",
"ุงูุฌู","ุงููุฒูู","ุงููุฏุซุฑ","ุงูููุงูุฉ","ุงูุฅูุณุงู","ุงููุฑุณูุงุช","ุงููุจุฃ","ุงููุงุฒุนุงุช","ุนุจุณ","ุงูุชูููุฑ",
"ุงูุฅููุทุงุฑ","ุงููุทูููู","ุงูุฅูุดูุงู","ุงูุจุฑูุฌ","ุงูุทุงุฑู","ุงูุฃุนูู","ุงูุบุงุดูุฉ","ุงููุฌุฑ","ุงูุจูุฏ",
"ุงูุดูุณ","ุงูููู","ุงูุถุญู","ุงูุดุฑุญ","ุงูุชูู","ุงูุนูู","ุงููุฏุฑ","ุงูุจููุฉ","ุงูุฒูุฒูุฉ","ุงูุนุงุฏูุงุช",
"ุงููุงุฑุนุฉ","ุงูุชูุงุซุฑ","ุงูุนุตุฑ","ุงูููุฒุฉ","ุงูููู","ูุฑูุด","ุงููุงุนูู","ุงูููุซุฑ","ุงููุงูุฑูู","ุงููุตุฑ",
"ุงููุณุฏ","ุงูุฅุฎูุงุต","ุงูููู","ุงููุงุณ"
];

const surahSelect = document.getElementById('surah');
for(let i=0;i<114;i++){
  const num = (i+1).toString().padStart(3,'0'); // 001..114
  const opt = document.createElement('option');
  opt.value = num;
  opt.textContent = `${num} โ ${surahNames[i]}`;
  surahSelect.appendChild(opt);
}

const reciterSelect = document.getElementById('reciter');
const player = document.getElementById('player');
const logBox = document.getElementById('log');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const clearCacheBtn = document.getElementById('clearCacheBtn');

function log(msg){
  const time = new Date().toLocaleTimeString();
  logBox.innerHTML = `<div>โข ${time} โ ${msg}</div>` + logBox.innerHTML;
}

// ูุงุฆูุฉ ุณูุฑูุฑุงุช mp3quran ููุญุงููุฉ fallback
const mp3Servers = [
  'https://server8.mp3quran.net',
  'https://server11.mp3quran.net',
  'https://server6.mp3quran.net',
  'https://server13.mp3quran.net',
  'https://server7.mp3quran.net'
];

// ุฏุงูุฉ ุชุจูู ูุงุฆุญุฉ ุฑูุงุจุท ูุฑุดุญุฉ ูุณูุฑุฉ ููุงุฑุฆ
function buildCandidateUrls(reciterKey, surahNum){
  const candidates = [];
  // ุฅุฐุง ุงููุงุฑุฆ ูููุฉ ุชุจุฏุฃ ุจู "ar." ููุชุฑุถ ูุตุฏุฑ cdn.islamic.network
  if(reciterKey.startsWith('ar.')){
    // cdn islamic network uses 1..114 (no zero padding in many paths or sometimes 1.mp3)
    // but we'll keep 001..114 like earlier examples (some CDNs use 1.mp3 too)
    // ูุฏุฑุฌ ุฑุงุจุท 3 ุฃุดูุงู ูุฒูุงุฏุฉ ูุฑุต ุงูุชุดุบูู
    candidates.push(`https://cdn.islamic.network/quran/audio-surah/128/${reciterKey}/${parseInt(surahNum,10)}.mp3`);
    candidates.push(`https://cdn.islamic.network/quran/audio-surah/128/${reciterKey}/${surahNum}.mp3`);
    // ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุนูู mp3quran servers ุฅู ูุงู ูุฏููู ูุฌูุฏุงุช ุจููุณ ุงุณู ุงููุงุฑุฆ (ูุญุชูุธ ุจูุง ููู ุชุฑุชูุจ ูุงุญู)
  } else {
    // mp3quran style (reciterKey like s_gmd or juhany)
    for(const server of mp3Servers){
      candidates.push(`${server}/${reciterKey}/${surahNum}.mp3`);
      // ุจุนุถ ุงูุณูุฑูุฑุงุช ุชุณุชุนูู 1.mp3 ุจุฏูุงู ูู 001.mp3 โ ูุถูู ูุญุงููุฉ
      candidates.push(`${server}/${reciterKey}/${parseInt(surahNum,10)}.mp3`);
    }
  }
  // ูููุฏู ุงุญุชูุงุทู: ูุณุฌู ุฑูุงุจุท cdn.islamic.network ูุงุณู ุงููุงุฑุฆ ูู ar.NAME ุฅุฐุง ูุงู ููุฌูุฏ
  if(!reciterKey.startsWith('ar.')){
    // mapping ูุจุนุถ ุงูุฃุณูุงุก ุงูุดุงุฆุนุฉ ูู cdn (ูุญุงููุฉ ุฅุถุงููุฉ)
    const mapping = {
      's_gmd': 'ar.saad_alghamdi',
      'juhany': 'ar.abdullah_al_juhany'
    };
    if(mapping[reciterKey]){
      candidates.push(`https://cdn.islamic.network/quran/audio-surah/128/${mapping[reciterKey]}/${surahNum}.mp3`);
      candidates.push(`https://cdn.islamic.network/quran/audio-surah/128/${mapping[reciterKey]}/${parseInt(surahNum,10)}.mp3`);
    }
  }
  // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
  return [...new Set(candidates)];
}

// ุฏุงูุฉ ุชุญุงูู ุชุดุบูู ูู ูุงุฆูุฉ ุฑูุงุจุท ูุงุญุฏุฉ ุชูู ุงูุฃุฎุฑู
async function tryPlayCandidates(candidates){
  // ูุนูุฏ ูุตุฏุฑ ูุงุฌุญ ุฃู null
  for(const url of candidates){
    log(`ุฌุฑุจ ุฑุงุจุท: ${url}`);
    try{
      // ูุญุงูู ุชุญููู ุฑุฃุณ ุงูููู ุฃููุงู ููุชุฃูุฏ (HEAD) ููู ุจุนุถ ุงูุณูุฑูุฑุงุช ูุง ุชุณูุญ HEAD -> ูุณุชุฎุฏู fetch ูุน mode:'no-cors' ุบูุฑ ุตุงูุญ ููุง
      // ุณูุฌุฑุจ ูุจุงุดุฑุฉ ุถุจุท src ูุชุดุบููุ ููุณุชูุน ูุญุฏุซ error ุฃู canplay
      await attemptSetAndPlay(url);
      log(`ูุฌุญ ุงูุชุดุบูู ูู: ${url}`);
      return url;
    } catch(e){
      log(`ูุดู ุงูุฑุงุจุท โ ${url}`);
      // ูุฌุฑุจ ุงูุชุงูู
    }
  }
  return null;
}

// attemptSetAndPlay: ูุนูุฏ Promise ููุฌุญ ุฅุฐุง ุจุฏุฃ ุงูุชุดุบูู ุฃู ูุฑูุถ ุฅุฐุง ูุดู
function attemptSetAndPlay(url){
  return new Promise((resolve, reject) => {
    let resolved = false;
    // ุชูุธูู ุงูุฃุญุฏุงุซ ุงููุฏููุฉ
    player.pause();
    player.removeAttribute('src');
    player.load();

    // ูุคูุช ุฒูู ูุงูุชุธุงุฑ ุงูุงุณุชุฌุงุจุฉ (ูุซูุงู 10 ุซูุงูู)
    const timeout = setTimeout(() => {
      if(!resolved){
        resolved = true;
        player.pause();
        player.removeAttribute('src');
        player.load();
        reject(new Error('timeout'));
      }
    }, 10000);

    function onCanPlay(){
      if(resolved) return;
      resolved = true;
      clearTimeout(timeout);
      player.play().catch(()=>{}); // ุชุดุบูู ุฅุฐุง ุฃููู
      cleanup();
      resolve(true);
    }
    function onError(){
      if(resolved) return;
      resolved = true;
      clearTimeout(timeout);
      cleanup();
      reject(new Error('audio error'));
    }
    function cleanup(){
      player.removeEventListener('canplay', onCanPlay);
      player.removeEventListener('error', onError);
    }

    player.addEventListener('canplay', onCanPlay);
    player.addEventListener('error', onError);
    // ูุถุน ุงููุตุฏุฑ ุซู ูุญููู
    player.src = url;
    player.load();
  });
}

playBtn.addEventListener('click', async ()=>{
  playBtn.disabled = true;
  const reciter = reciterSelect.value;
  const surah = surahSelect.value;
  log(`ุจุฏุก ุชุดุบูู ุงูุณูุฑุฉ ${surah} ูููุงุฑุฆ ${reciter} ...`);
  const candidates = buildCandidateUrls(reciter, surah);
  const success = await tryPlayCandidates(candidates);
  if(success){
    log(`ุชู ุงูุชุดุบูู ูู: ${success}`);
  } else {
    log('ูู ูุชููู ูู ุฅูุฌุงุฏ ุฑุงุจุท ุตุงูุญ โ ุฌุฑูุจ ูุงุฑุฆ ุฃู ุดุจูุฉ ุฃุฎุฑู.');
    alert('ูู ูุชููู ูู ุฅูุฌุงุฏ ุฑุงุจุท ุตุงูุญ ููุณูุฑุฉ ูู ุงููุตุงุฏุฑ ุงูุญุงููุฉ. ุฌุฑูุจ ุชุบููุฑ ุงููุงุฑุฆ ุฃู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุงุญููุง.');
  }
  playBtn.disabled = false;
});

// ุฃุฒุฑุงุฑ ุงูุณุงุจู ูุงูุชุงูู
prevBtn.addEventListener('click', ()=> {
  let i = parseInt(surahSelect.selectedIndex,10);
  if(i>0){ surahSelect.selectedIndex = i-1; }
});
nextBtn.addEventListener('click', ()=> {
  let i = parseInt(surahSelect.selectedIndex,10);
  if(i < surahSelect.options.length-1){ surahSelect.selectedIndex = i+1; }
});

// ูุณุญ ุงูููุบ
clearCacheBtn.addEventListener('click', ()=> { logBox.innerHTML=''; });

// ูุดุบู ุชููุงุฆูุงู ุฅู ุชู ุชุญููู ููู ุนุจุฑ ุฑุงุจุท ูุจุงุดุฑ ูู ุงูู URL (ุงุฎุชูุงุฑู)
window.addEventListener('load', ()=>{
  // ุงุฎุชูุงุฑ ุงูุชุฑุงุถู: ุณูุฑุฉ ุงููุงุช
