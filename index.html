<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مشغل القرآن — احترافي</title>
<style>
  :root{
    --bg1:#07121a; --bg2:#072432; --card:#0b3450; --accent:#ffd166; --muted:#9fb3c4;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Cairo",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
  .app{width:100%;max-width:960px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(2,6,12,0.6)}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#08324a,#045a66);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);font-size:18px}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,button{width:100%;padding:12px;border-radius:10px;border:0;font-size:15px}
  select{background:rgba(0,0,0,0.2);color:#fff}
  button.primary{background:var(--accent);color:#071217;font-weight:700;cursor:pointer}
  .player{margin-top:14px;background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .meta{flex:1;min-width:200px}
  .now{font-weight:700;font-size:16px}
  .sub{color:var(--muted);font-size:13px;margin-top:6px}
  audio{width:100%;outline:none;margin-top:10px;border-radius:8px}
  .big-play{display:flex;gap:10px;align-items:center}
  .big-play button{padding:14px 20px;border-radius:12px;font-size:16px}
  .pill{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px}
  .controls-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .small{font-size:13px;padding:8px 10px}
  .log{margin-top:12px;background:#031523;padding:10px;border-radius:8px;color:#9fd0e6;font-size:13px;max-height:160px;overflow:auto}
  footer{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
  @media(max-width:640px){
    .controls{grid-template-columns:1fr}
    h1{font-size:18px}
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="مشغل القرآن">
    <header>
      <div class="logo" aria-hidden="true">قُرآن</div>
      <div>
        <h1>مشغل القرآن — احترافي</h1>
        <p class="lead">اختَر سورة وقارئ واضغط تشغيل — النظام يجرب مصدرًا مضمونًا ثم احتياطياً.</p>
      </div>
    </header>

    <div class="controls" role="region" aria-label="إعدادات التشغيل">
      <div>
        <label for="reciterSelect">القارئ</label>
        <select id="reciterSelect" aria-label="اختر القارئ">
          <option value="saad">سعد الغامدي</option>
          <option value="juhani">عبد الله الجهني</option>
          <option value="yassin">ياسين الجزائري</option>
        </select>
      </div>

      <div>
        <label for="surahSelect">السورة</label>
        <select id="surahSelect" aria-label="اختر السورة"></select>
      </div>

      <div style="grid-column:1/-1">
        <div class="big-play">
          <button id="playBtn" class="primary">▶ تشغيل السورة</button>
          <div style="flex:1" class="pill">
            <strong id="nowTitle">جاهز</strong>
            <div id="nowSub" class="sub">اختر سورة وقارئ ثم اضغط تشغيل</div>
          </div>
        </div>
      </div>
    </div>

    <div class="player" aria-live="polite">
      <div class="meta">
        <audio id="audioPlayer" controls preload="none"></audio>
        <div class="controls-row">
          <button id="prevBtn" class="small">السابق</button>
          <button id="nextBtn" class="small">التالي</button>
          <button id="autoplayToggle" class="small">تشغيل التلقائي: إيقاف</button>
        </div>
      </div>
    </div>

    <div class="log" id="logBox" aria-hidden="false">سجل التشغيل سيظهر هنا.</div>
    <footer>إذا منع المتصفح التشغيل التلقائي: اضغط زر التشغيل داخل مشغّل الصوت.</footer>
  </div>

<script>
/* احترافي: كل 114 سورة + 3 قرّاء + مصادر fallback
   - يجرب أولاً cdn.islamic.network (CORS-friendly)
   - ثم mp3quran servers كاحتياط
   - أزرار سابق/التالي + autoplay للسورة التالية
*/

const surahNames = [
"الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة",
"يونس","هود","يوسف","الرعد","إبراهيم","الحجر","النحل","الإسراء","الكهف",
"مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل",
"القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبأ","فاطر","يس",
"الصافات","ص","الزمر","غافر","فصلت","الشورى","الزخرف","الدخان","الجاثية",
"الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر",
"الرحمن","الواقعة","الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون",
"التغابن","الطلاق","التحريم","الملك","القلم","الحاقة","المعارج","نوح","الجن",
"المزمل","المدثر","القيامة","الإنسان","المرسلات","النبأ","النازعات","عبس","التكوير",
"الانفطار","المطففين","الانشقاق","البروج","الطارق","الأعلى","الغاشية","الفجر","البلد",
"الشمس","الليل","الضحى","الشرح","التين","العلق","القدر","البينة","الزلزلة",
"العاديات","القارعة","التكاثر","العصر","الهمزة","الفيل","قريش","الماعون","الكوثر",
"الكافرون","النصر","المسد","الإخلاص","الفلق","الناس"
];

// reciter key -> cdn name + mp3quran path(s)
const recitersMeta = {
  saad: {
    cdn: 'ar.saad_alghamdi',
    mp3qServers: ['https://server8.mp3quran.net/s_gmd/','https://server6.mp3quran.net/s_gmd/']
  },
  juhani: {
    cdn: 'ar.abdullah_aljuhani',
    mp3qServers: ['https://server11.mp3quran.net/jhn/','https://server7.mp3quran.net/juhany/']
  },
  yassin: {
    cdn: 'ar.yassin_aljazairi',
    mp3qServers: ['https://server11.mp3quran.net/yassin/','https://server8.mp3quran.net/yassin/']
  }
};

const surahSelect = document.getElementById('surahSelect');
const reciterSelect = document.getElementById('reciterSelect');
const playBtn = document.getElementById('playBtn');
const audio = document.getElementById('audioPlayer');
const logBox = document.getElementById('logBox');
const nowTitle = document.getElementById('nowTitle');
const nowSub = document.getElementById('nowSub');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const autoplayToggle = document.getElementById('autoplayToggle');

let autoplayNext = false;

// fill surah list
surahNames.forEach((n,i)=>{
  const opt = document.createElement('option');
  const num3 = String(i+1).padStart(3,'0');
  opt.value = num3;
  opt.textContent = `${num3} — ${n}`;
  surahSelect.appendChild(opt);
});

// logging helper
function log(msg){
  const t = new Date().toLocaleTimeString();
  logBox.innerHTML = `<div>• ${t} — ${msg}</div>` + logBox.innerHTML;
}

// try sources in order and return first working URL or null
async function findWorkingUrl(reciterKey, surahNum){
  const meta = recitersMeta[reciterKey];
  if(!meta) return null;
  const num3 = String(Number(surahNum)).padStart(3,'0');

  // candidates: cdn.islamic.network, then mp3q servers
  const candidates = [];
  candidates.push(`https://cdn.islamic.network/quran/audio-surah/128/${meta.cdn}/${num3}.mp3`);
  for(const s of meta.mp3qServers) candidates.push(`${s}${num3}.mp3`);

  log(`اختبار مصادر ${candidates.length} للرابط (سورة ${num3})`);
  for(const url of candidates){
    log(`جرب: ${url}`);
    // quick test: try load metadata by assigning src then wait for canplay or error
    audio.src = url;
    audio.load();
    const ok = await new Promise(resolve=>{
      let done=false;
      const onOk=()=>{ if(!done){ done=true; cleanup(); resolve(true); } };
      const onErr=()=>{ if(!done){ done=true; cleanup(); resolve(false); } };
      const timer = setTimeout(()=>{ if(!done){ done=true; cleanup(); resolve(false); } },6000);
      function cleanup(){
        audio.removeEventListener('canplay', onOk);
        audio.removeEventListener('canplaythrough', onOk);
        audio.removeEventListener('error', onErr);
        clearTimeout(timer);
      }
      audio.addEventListener('canplay', onOk);
      audio.addEventListener('canplaythrough', onOk);
      audio.addEventListener('error', onErr);
    });
    if(ok){
      log(`مقبول: ${url}`);
      return url;
    } else {
      log(`فشل: ${url}`);
    }
  }
  return null;
}

async function playSelected(){
  const surah = surahSelect.value;
  const reciterKey = reciterSelect.value;
  nowTitle.textContent = `${String(Number(surah)).padStart(3,'0')} — ${surahNames[Number(surah)-1]}`;
  nowSub.textContent = `جارٍ البحث عن مصدر للقارئ ${reciterSelect.selectedOptions[0].text}...`;
  log(`بدء تشغيل: سورة ${surah} — قارئ ${reciterKey}`);

  const url = await findWorkingUrl(reciterKey, surah);
  if(!url){
    nowSub.textContent = 'لم نتمكن من إيجاد مصدر صالح. جرّب قارئًا آخر.';
    log('لم يتم العثور على رابط صالح.');
    return;
  }
  audio.src = url;
  try{
    await audio.play();
    nowSub.textContent = `المصدر: ${url}`;
    log('تم البدء بالتشغيل.');
  }catch(e){
    nowSub.textContent = 'المتصفح منع التشغيل التلقائي — اضغط زر تشغيل داخل المشغّل.';
    log('رابط صالح لكن المتصفح منع التشغيل التلقائي.');
  }
}

// events
playBtn.addEventListener('click', playSelected);

prevBtn.addEventListener('click', ()=>{
  let idx = parseInt(surahSelect.selectedIndex);
  if(idx>0){ surahSelect.selectedIndex = idx-1; playSelected(); }
});

nextBtn.addEventListener('click', ()=>{
  let idx = parseInt(surahSelect.selectedIndex);
  if(idx < surahSelect.options.length-1){ surahSelect.selectedIndex = idx+1; playSelected(); }
});

autoplayToggle.addEventListener('click', ()=>{
  autoplayNext = !autoplayNext;
  autoplayToggle.textContent = `تشغيل التلقائي: ${autoplayNext ? 'تشغيل' : 'إيقاف'}`;
});

audio.addEventListener('ended', ()=>{
  log('انتهت السورة');
  if(autoplayNext){
    let idx = surahSelect.selectedIndex;
    if(idx < surahSelect.options.length-1){
      surahSelect.selectedIndex = idx+1;
      playSelected();
    } else {
      log('انتهت قائمة السور.');
    }
  }
});

// keyboard: space to play/pause
document.addEventListener('keydown',(e)=>{
  if(e.code === 'Space'){ e.preventDefault(); if(audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
});

// initial log
log('جاهز — اختر سورة وقارئ ثم اضغط تشغيل.');
</script>
</body>
</html>
